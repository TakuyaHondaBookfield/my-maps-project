<!DOCTYPE html>
<html>
<head>
    <title>Google Maps - Multiple Markers & Distance</title>
    <style>
        #map {
            width: 100%;
            height: 500px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h2>Google Maps - è¤‡æ•°ãƒãƒ¼ã‚«ãƒ¼ã¨è·é›¢æ¸¬å®š</h2>

    <label for="api-key">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</label>
    <input type="text" id="api-key" placeholder="Google Maps API Key ã‚’å…¥åŠ›">
    <button onclick="loadGoogleMaps()">ãƒ­ãƒ¼ãƒ‰</button>

    <div id="map"></div>
    <div id="results"></div>

    <script>
        let map;
        let markers = [];
        let locations = [
            { address: "æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1" },
            { address: "æ±äº¬éƒ½æ¸‹è°·åŒºé“ç„å‚2ä¸ç›®11-1" },
            { address: "æ±äº¬éƒ½æ¸¯åŒºèµ¤å‚9ä¸ç›®7-1" }
        ];
        let geocoder;
        let apiKey = "";

        function loadGoogleMaps() {
            apiKey = document.getElementById("api-key").value;
            if (!apiKey) {
                alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            // ã™ã§ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
            const oldScript = document.getElementById("google-maps-script");
            if (oldScript) {
                oldScript.remove();
            }

            // Google Maps APIã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«è¿½åŠ 
            const script = document.createElement("script");
            script.id = "google-maps-script";
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 35.6895, lng: 139.6917 }, // åˆæœŸä½ç½®ï¼ˆæ±äº¬ï¼‰
                zoom: 12,
            });

            geocoder = new google.maps.Geocoder();

            locations.forEach((location, index) => {
                geocoder.geocode({ address: location.address }, (results, status) => {
                    if (status === "OK") {
                        let position = results[0].geometry.location;
                        let marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: location.address
                        });
                        markers.push({ marker, position, address: location.address });

                        // ã™ã¹ã¦ã®åœ°ç‚¹ãŒå–å¾—ã§ããŸã‚‰è·é›¢ã‚’æ¸¬å®š
                        if (markers.length === locations.length) {
                            calculateDistances();
                        }
                    } else {
                        console.error("Geocode failed for " + location.address + ": " + status);
                    }
                });
            });
        }

        function calculateDistances() {
            let resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "<h3>è·é›¢ã®æ¸¬å®šçµæœ</h3>";
        
            for (let i = 0; i < markers.length; i++) {
                for (let j = i + 1; j < markers.length; j++) {
                    let loc1 = markers[i];
                    let loc2 = markers[j];
        
                    // ç›´ç·šè·é›¢ã‚’è¨ˆç®—
                    let directDistance = google.maps.geometry.spherical.computeDistanceBetween(loc1.position, loc2.position);
                    let directDistanceKm = (directDistance / 1000).toFixed(2);

                    // ğŸš€ CORSãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ã¦ Distance Matrix API ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    fetch(`https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(loc1.address)}&destinations=${encodeURIComponent(loc2.address)}&mode=driving&key=${apiKey}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === "OK") {
                                let distanceText = data.rows[0].elements[0].distance.text;
                                resultsDiv.innerHTML += `<p>${loc1.address} â‡” ${loc2.address}:<br>ç›´ç·šè·é›¢: ${directDistanceKm} km<br>é“è·¯è·é›¢: ${distanceText}</p>`;
                            } else {
                                resultsDiv.innerHTML += `<p>${loc1.address} â‡” ${loc2.address}:<br>ç›´ç·šè·é›¢: ${directDistanceKm} km<br>é“è·¯è·é›¢: è¨ˆæ¸¬å¤±æ•—</p>`;
                            }
                        })
                        .catch(error => console.error("Distance API Error:", error));
                }
            }
        }
    </script>
</body>
</html>
